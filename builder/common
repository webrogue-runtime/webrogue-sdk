set -ex

docker --version | grep podman >/dev/null || {
    DOCKER_USER_FLAGS="-u $(id -u ${USER}):$(id -g ${USER})"
}
SDK_DIR=$(dirname $(pwd))

builder_image_name=webrogue_sdk_builder
docker build -t $builder_image_name .
run_in_builder_docker() {
    docker run \
        --rm \
        -v $SDK_DIR/libraries:/libraries \
        -v $SDK_DIR/cargo/src:/fakehome/.cargo/registry/src \
        -v $SDK_DIR/cargo/cache:/fakehome/.cargo/registry/cache \
        -v $SDK_DIR/cargo/index:/fakehome/.cargo/registry/index \
        -v $SDK_DIR/opt:/opt \
        -v $SDK_DIR/meson:/meson \
        -v $SDK_DIR/package:/package \
        $DOCKER_USER_FLAGS \
        -t $builder_image_name \
        bash -c "$1"
}


examples_builder_image_name=webrogue_sdk_examples_builder
run_in_examples_builder_docker() {
    docker run \
        --rm \
        -v $(pwd):/examples_host_dir \
        -v $(dirname $(pwd))/webrogue-sdk/libraries:/libraries \
        $DOCKER_USER_FLAGS \
        -t $examples_builder_image_name \
        bash -c "$1"
}

#  \
